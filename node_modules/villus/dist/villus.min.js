/**
  * villus v2.0.1
  * (c) 2022 Abdelrahman Awad
  * @license MIT
  */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vue"),require("graphql")):"function"==typeof define&&define.amd?define(["exports","vue","graphql"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Villus={},e.Vue,e.graphql)}(this,(function(e,t,r){"use strict";function n(e,r){return t.isRef(e)?e.value:"function"==typeof e?e(t.unref(r)):e}function o(e){return t.isRef(e)?t.unref(e):"function"==typeof e?e():e}function u(e){return t.isRef(e)||t.isReactive(e)||"function"==typeof e}function i(e){return"string"==typeof e?new r.GraphQLError(e):"object"==typeof e&&e.message?new r.GraphQLError(e.message,e.nodes,e.source,e.positions,e.path,e,e.extensions||{}):e}class s extends Error{constructor({response:e,networkError:t,graphqlErrors:r}){const n=null==r?void 0:r.map(i),o=((e,t)=>{let r="";return void 0!==e?r=`[Network] ${e.message}`:(void 0!==t&&t.forEach((e=>{r+=`[GraphQL] ${e.message}\n`})),r.trim())})(t,n);super(o),this.name="CombinedError",this.response=e,this.message=o,this.networkError=t,this.graphqlErrors=n}get isGraphQLError(){return!(!this.graphqlErrors||!this.graphqlErrors.length)}toString(){return this.message}}var a=function(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});var r,n="boolean"==typeof t.cycles&&t.cycles,o=t.cmp&&(r=t.cmp,function(e){return function(t,n){var o={key:t,value:e[t]},u={key:n,value:e[n]};return r(o,u)}}),u=[];return function e(t){if(t&&t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),void 0!==t){if("number"==typeof t)return isFinite(t)?""+t:"null";if("object"!=typeof t)return JSON.stringify(t);var r,i;if(Array.isArray(t)){for(i="[",r=0;r<t.length;r++)r&&(i+=","),i+=e(t[r])||"null";return i+"]"}if(null===t)return"null";if(-1!==u.indexOf(t)){if(n)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var s=u.push(t)-1,a=Object.keys(t).sort(o&&o(t));for(i="",r=0;r<a.length;r++){var l=a[r],c=e(t[l]);c&&(i&&(i+=","),i+=JSON.stringify(l)+":"+c)}return u.splice(s,1),"{"+i+"}"}}(e)};function l(e){return"string"==typeof e?e:e&&e.kind?r.print(e):null}async function c(e){let t;const r={ok:e.ok,statusText:e.statusText,status:e.status,headers:e.headers};try{t=await e.json()}catch(e){return Object.assign(Object.assign({},r),{statusText:e.message,body:null})}return Object.assign(Object.assign({},r),{body:t})}const f={method:"POST",headers:{"content-type":"application/json"}};function d(e,t){return Object.assign(Object.assign(Object.assign({},e),t),{method:t.method||e.method||f.method,headers:Object.assign(Object.assign({},e.headers||{}),t.headers||{})})}function h({query:e,variables:t},r){const n=l(e);if(!n)throw new Error("A query must be provided.");return d({body:JSON.stringify({query:n,variables:t})},r)}function p(e){let t,r,n;for(t=5381,r=0,n=0|e.length;r<n;r++)t=(t<<5)+t+e.charCodeAt(r);return t>>>0}function y(e,...t){const r=e.variables?a(e.variables):"";return p(`${l(e.query)}${r}${t.join("")}`)}function v(){const e={};return function({afterQuery:t,useResult:r,operation:n}){if("query"!==n.type||"network-only"===n.cachePolicy)return;t((t=>{!function({key:t},r){e[t]=r}(n,t)}));const o=function({key:t}){return e[t]}(n);return"cache-only"===n.cachePolicy?r(o||{data:null,error:null},!0):o?r(o,"cache-first"===n.cachePolicy):void 0}}function g(e){const t=(null==e?void 0:e.fetch)||("undefined"!=typeof window&&"fetch"in window&&window.fetch?window.fetch.bind(window):"undefined"!=typeof global&&"fetch"in global?global.fetch:"undefined"!=typeof self&&"fetch"in self?self.fetch:void 0);if(!t)throw new Error("Could not resolve a fetch() method, you should provide one.");return async function(e){var r,n;const{useResult:o,opContext:u,operation:i}=e,a=h(i,u);let l;try{l=await t(u.url,a).then(c)}catch(e){return o({data:null,error:new s({response:l,networkError:e})},!0)}e.response=l;const f=null===(r=l.body)||void 0===r?void 0:r.data;if(!l.ok||!l.body){const e={response:l};return(null===(n=l.body)||void 0===n?void 0:n.errors)?e.graphqlErrors=l.body.errors:e.networkError=new Error(l.statusText),o({data:f,error:new s(e)},!0)}o({data:f,error:l.body.errors?new s({response:l,graphqlErrors:l.body.errors}):null},!0)}}function b(){const e={};return function(t){if("query"!==t.operation.type)return;const{useResult:r}=t;t.afterQuery((()=>{delete e[t.operation.key]}));const n=e[t.operation.key];if(n)return n.then((e=>{r(e,!0)}));let o;e[t.operation.key]=new Promise((e=>{o=e})),t.useResult=function(...e){r(...e),o(e[0])}}}const w=Symbol("villus.client");let m;const O=e=>m=e,j=()=>{var e;const r=t.getCurrentInstance();return r?(null===(e=r.provides)||void 0===e?void 0:e[w])||t.inject(w,m):m},x=()=>[v(),b(),g()];class E{constructor(e){this.install=()=>{},this.url=e.url,this.defaultCachePolicy=e.cachePolicy||"cache-first",this.plugins=e.use||[...x()]}async execute(e,t,r,n){let o;const u=Object.assign(Object.assign({url:this.url},f),{headers:Object.assign(Object.assign({},f.headers),(null==r?void 0:r.headers)||{})});let i=!1;const s=[],a={useResult(e,t){t&&(i=!0),o&&(null==n||n(e)),o=e},afterQuery(e){s.push(e)},operation:Object.assign(Object.assign({},e),{key:y(e),type:t,cachePolicy:("cachePolicy"in e?e.cachePolicy:this.defaultCachePolicy)||this.defaultCachePolicy}),opContext:u};let l=0;for(let e=0;e<this.plugins.length;e++){const t=this.plugins[e];if(await t(a),o){l=e;break}}return new Promise(((e,t)=>{o?(e(o),(async()=>{if(!i)for(let e=l+1;e<this.plugins.length;e++){const t=this.plugins[e];await t(a)}const e={response:a.response};for(let t=0;t<s.length;t++){const r=s[t];await r(o,e)}})()):t(new Error("Operation result was not set by any plugin, make sure you have default plugins configured or review documentation"))}))}async executeQuery(e,t,r){return this.execute(e,"query",t,r)}async executeMutation(e,t){return this.execute(e,"mutation",t)}async executeSubscription(e){return await this.execute(e,"subscription")}}function q(e){const t=new E(e);return t.install=e=>{O(t),e.provide(w,t)},t}function k(){const e=t.getCurrentInstance();let r=e&&t.inject(w,function(e,t){var r,n,o,u;return(null===(n=null===(r=null==e?void 0:e.proxy)||void 0===r?void 0:r._provided)||void 0===n?void 0:n[t])||(null===(o=null==e?void 0:e._provided)||void 0===o?void 0:o[t])||(null===(u=null==e?void 0:e.provides)||void 0===u?void 0:u[t])}(e,w));if(r&&O(r),r=j(),null==r)throw new Error("Cannot detect villus Client, did you forget to call `useClient`? Alternatively, you can explicitly pass a client as the `manualClient` argument.");return r}const C=(e,t)=>t.data;e.Client=E,e.CombinedError=s,e.VILLUS_CLIENT=w,e.cache=v,e.createClient=q,e.dedup=b,e.defaultPlugins=x,e.definePlugin=function(e){return e},e.fetch=g,e.getActiveClient=j,e.getQueryKey=y,e.handleSubscriptions=function(e){const t=e;return function({operation:e,useResult:r}){if("subscription"===e.type){if(!t)throw new Error("No subscription forwarder was set.");r(t(e),!0)}}},e.makeFetchOptions=h,e.mergeFetchOpts=d,e.parseResponse=c,e.setActiveClient=O,e.useClient=function(e){const r=q(e);return t.provide(w,r),r},e.useMutation=function(e,r){var n;const o=null!==(n=null==r?void 0:r.client)&&void 0!==n?n:k(),u=t.ref(null),i=t.ref(!1),s=t.ref(!1),a=t.ref(null);let l;return{data:u,isFetching:i,isDone:s,error:a,execute:async function(n){i.value=!0;const c=n||{},f=o.executeMutation({query:e,variables:c},t.unref(null==r?void 0:r.context));l=f;const d=await f;return f!==l?{data:d.data,error:d.error}:(u.value=d.data,a.value=d.error,s.value=!0,i.value=!1,l=void 0,{data:u.value,error:a.value})}}},e.useQuery=function(e){var r;const i=null!==(r=null==e?void 0:e.client)&&void 0!==r?r:k(),{query:s,variables:l,cachePolicy:c,fetchOnMount:f,paused:d,skip:h}=function(e){const t={variables:{},fetchOnMount:!0};return Object.assign(Object.assign(Object.assign({},t),e),{query:e.query})}(e);let y=f;const v=t.ref(null),g=t.ref(null!=f&&f),b=t.ref(!1),w=t.ref(!0),m=t.ref(null);let O;const j=()=>n(d,l||{});function x(e){v.value=e.data,m.value=e.error}async function E(r){const u=o(l)||{};if(n(h,u))return g.value=!1,{data:v.value,error:m.value};g.value=!0;const a=i.executeQuery({query:t.isRef(s)?s.value:s,variables:o((null==r?void 0:r.variables)||u),cachePolicy:(null==r?void 0:r.cachePolicy)||c},t.unref(null==e?void 0:e.context),x);O=a;const f=await a;return a!==O?{data:f.data,error:f.error}:(x(f),b.value=!0,g.value=!1,w.value=!1,O=void 0,{data:v.value,error:m.value})}function q(){j()||E()}t.isRef(s)&&t.watch(s,q),u(d)&&t.watch((()=>!j()),(e=>{e&&w.value&&E()})),function(){let e;l&&u(l)&&t.watch((()=>o(l)),(t=>{const r=p(a(t));r!==e&&(e=r,w.value=!0,q())}),{deep:!0})}();const C={data:v,isFetching:g,isDone:b,error:m,execute:E},P=t.getCurrentInstance();return y&&(d&&j()||(P?t.onMounted((()=>E())):E())),Object.assign(Object.assign({},C),{then:async e=>(y=!1,await C.execute(),e(C))})},e.useSubscription=function(e,r=C){var o;const i=null!==(o=e.client)&&void 0!==o?o:k(),{query:a,variables:l,paused:c}=e,f=t.ref(r(null,{data:null,error:null})),d=t.ref(null),h=t.computed((()=>n(c,l)));function p(e){f.value=r(f.value,e),d.value=e.error}let y;async function v(){null==y||y.unsubscribe();const e=await i.executeSubscription({query:t.unref(a),variables:t.unref(l)});return y=e.subscribe({next(e){if(h.value)return;const t=function(e){if(!e.errors)return{data:e.data||null,error:null};return{data:e.data||null,error:new s({graphqlErrors:[...e.errors],response:null})}}(e);p(t)},complete(){},error(e){if(h.value)return;return p({data:null,error:new s({networkError:e,response:null})})}}),y}const g=t.getCurrentInstance();return h.value||(g?t.onMounted(v):v()),g&&t.onBeforeUnmount((()=>null==y?void 0:y.unsubscribe())),u(c)&&t.watch(c,(e=>{e||v()})),t.isRef(a)&&t.watch(a,v),t.isRef(l)&&t.watch(l,v),{data:f,error:d,paused:h}},Object.defineProperty(e,"__esModule",{value:!0})}));